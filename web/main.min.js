const LogOut={view:()=>{return[m("button[type=button].mb-5",{title:"logout "+username,onclick:function(){sessionStorage.removeItem("token");m.request({method:"GET",url:"/logout",user:"thisIsForLogout",}).catch(function(e){if(e.code===401){console.log("User logged out.");m.route.set("/");window.location.reload();}})}},"logout"),]}}
const ThemeSwitch={view:()=>{return m("div.toggle-switch",{title:"Light/Dark Mode"},m("label.switch",m("input",{type:"checkbox",name:"lightswitch",oncreate:function(vnode){vnode.dom.checked=isLightTheme(App.theme);},onclick:function(e){App.theme=(e.target.checked?"light-mode":"dark-mode");localStorage.setItem("theme",App.theme);}}),m("span.slider")));}}
const GridResize=(gridSelector,gutterSelector,areaSelector,gridTemplate,minSize=100,isColumn=false)=>{const grid=document.querySelector(gridSelector);const gutter=document.querySelector(gutterSelector);const area=grid.querySelector(areaSelector);let isDragging=false;let startPosition=0;let startAreaSize=0;let originalSize=0;function setNoSelect(state){state?document.body.classList.add('no-select'):document.body.classList.remove('no-select');}
const onMouseDown=(e)=>{isDragging=true;startPosition=isColumn?e.clientX:e.clientY;startAreaSize=isColumn?area.offsetWidth:area.offsetHeight;document.body.style.cursor=isColumn?'col-resize':'row-resize';setNoSelect(true);};const onMouseMove=(e)=>{if(!isDragging)return;const delta=isColumn?(e.clientX-startPosition):(e.clientY-startPosition);let newAreaSize=startAreaSize+delta;newAreaSize=Math.max(newAreaSize,minSize);const currentSizes=grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows'].split(' ');currentSizes[0]=`${newAreaSize}px`;grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows']=currentSizes.join(' ');};const onMouseUp=()=>{isDragging=false;document.body.style.cursor='';setNoSelect(false);};const onDoubleClick=()=>{const currentSizes=grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows'].split(' ');currentSizes[0]=`${originalSize}px`;grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows']=currentSizes.join(' ');};return{init:()=>{if(isColumn){grid.style.gridTemplateColumns=gridTemplate;originalSize=area.offsetWidth;}else{grid.style.gridTemplateRows=gridTemplate;originalSize=area.offsetHeight;}
gutter.addEventListener('mousedown',onMouseDown);gutter.addEventListener('dblclick',onDoubleClick);document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);},destroy:()=>{gutter.removeEventListener('mousedown',onMouseDown);gutter.removeEventListener('dblclick',onDoubleClick);document.removeEventListener('mousemove',onMouseMove);document.removeEventListener('mouseup',onMouseUp);}};};class TabState{constructor(defaultTab){this.currentTab=defaultTab;}
set(tab){this.currentTab=tab;}
get(){return this.currentTab;}
is(tab){return(this.currentTab===tab);}
selectedClass(tab){return(this.currentTab===tab)?"selected":"";}
displayClass(tab){return(this.currentTab===tab)?"":"display-none";}}
class TableDim{constructor(){this.rows=[[]];this.charWidth=6.5;this.availableWidth=0;this.tdPadding=12;this.colWidths=new Map();this.totalWidth=0;}
setRows(newRows){this.rows=newRows;return this;}
setCharWidth(newCharWidth){this.charWidth=newCharWidth;return this;}
setAvailableWidth(newAvailableWidth){this.availableWidth=newAvailableWidth;return this;}
setTdPadding(newTdPadding){this.tdPadding=newTdPadding;return this;}
getColWidths(){return this.colWidths;}
getColWidth(colIdx){return Math.floor(this.colWidths.get(colIdx));}
getTotalWidth(){return this.totalWidth;}
calc(){const maxColLengths=new Map();this.colWidths=new Map();this.totalWidth=0;this.rows.forEach(row=>{row.forEach((col,idx)=>{const len=Math.max(String(col).length,2);if(!maxColLengths.has(idx)||len>maxColLengths.get(idx)){maxColLengths.set(idx,len);}});});let remainingWidth=this.availableWidth;outerLoop:while(maxColLengths.size>0){const evenlyDistributedWidth=Math.floor(remainingWidth/maxColLengths.size);for(const[idx,maxLen]of maxColLengths){const idealWidth=maxLen*this.charWidth+this.tdPadding;if(idealWidth<=evenlyDistributedWidth){this.colWidths.set(idx,idealWidth);remainingWidth-=idealWidth;maxColLengths.delete(idx);continue outerLoop;}}
for(const[idx]of maxColLengths){const evenlyWidth=Math.floor(remainingWidth/maxColLengths.size);this.colWidths.set(idx,evenlyWidth);remainingWidth-=evenlyWidth;maxColLengths.delete(idx);}
break;}
if(remainingWidth>this.colWidths.size){let usedWidth=0;for(const[,v]of this.colWidths){usedWidth+=v;}
const addWidth=Math.floor(Math.min(remainingWidth/this.colWidths.size,usedWidth*0.2/this.colWidths.size));for(const[k,v]of this.colWidths){this.colWidths.set(k,v+addWidth);}}
for(const[,v]of this.colWidths){this.totalWidth+=v;}
return this;}}
const OptGroup={view:function(vnode){let currentGroup=null;let elements=[];vnode.attrs.rows.sort((a,b)=>{if(a[1]<b[1])return-1;if(a[1]>b[1])return 1;if(a[0]<b[0])return-1;if(a[0]>b[0])return 1;return 0;});vnode.attrs.rows.forEach(function(row){let groupLabel=row[1];let optionElement=m("option",{value:row[0]},row[0]);if(currentGroup!==groupLabel){currentGroup=groupLabel;elements.push(m("optgroup",{label:currentGroup},[optionElement]));}else{elements[elements.length-1].children.push(optionElement);}});return elements;}};const Cell={classTar(type){t=type.toLowerCase();return["name","text"].includes(t)||t.includes("char")?"":"tar";},classCell(val){if(val===null)return"cell-null";if(val===true)return"cell-true";if(val===false)return"cell-false";return"";},displayValue(val){if(val===null)return"null";if(val===true)return"true";if(val===false)return"false";return val;},view:(vnode)=>{return m("td",m("div",{class:[Cell.classTar(vnode.attrs.type),Cell.classCell(vnode.attrs.val)].join(" "),title:vnode.attrs.val},Cell.displayValue(vnode.attrs.val)))}}
const isLightTheme=(theme)=>{return theme.toLowerCase().includes('light');}
function WaitingAnimation(vnode){const animationState={baseText:vnode.attrs.text||"processing",repeatChar:vnode.attrs.repeatChar||".",dots:0,displayText:""};const startAnimation=()=>{animationState.interval=setInterval(()=>{animationState.dots=(animationState.dots+1)%4;animationState.displayText=animationState.baseText+animationState.repeatChar.repeat(animationState.dots);m.redraw();},500);};const stopAnimation=()=>{clearInterval(animationState.interval);};return{oncreate:startAnimation,onremove:stopAnimation,view:()=>m("span",{class:vnode.attrs.class},animationState.displayText||animationState.baseText)};}
const getRequestHeaders=()=>{return sessionStorage.getItem("token")!==null?{"Authorization-Jwt":"Bearer "+sessionStorage.getItem("token")}:{}}
const getRequestExtract=()=>{return function(xhr){const token=xhr.getResponseHeader("Authorization-Jwt");if(token){sessionStorage.setItem("token",token.split(" ")[1]);}
return JSON.parse(xhr.responseText);}}
const App={conn:"",schema:"",theme:"",tabState:new TabState("result"),oninit:()=>{var theme=localStorage.getItem("theme");App.theme=theme?theme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark-mode":"light-mode";},view:()=>{return m("div.grid-main",{class:App.theme},m("header.area-main-header",m("nav.brand",m("a",{href:"/"},versionInfo.appName),m("span.ml-10","v",versionInfo.server),)),m("section.area-main-menu",m("div.grid",{style:"grid-template-columns: auto 1fr auto;"},m("div.grid-col",m("div",m(ConnForm)),m("div.ml-10",m(SchemaForm))),m("div.grid-col.align-items-end.ml-10",m(ConnInfos)),m("div.grid-col.ml-auto.mr-0",m("div.ml-10",m(ThemeSwitch)),m("div.ml-10",m(LogOut))),),),m("section.area-main-content",!App.conn?null:[m("div.grid-query",{oncreate:function(vnode){var h0=document.querySelector('.grid-query').offsetHeight,h1=195,h2=335,h1=Math.max(h0-h2,h1);const LayoutGrid=GridResize('.grid-query','.area-query-splitter','.area-query-editor',`${h1}px 3px auto auto`,195,false);LayoutGrid.init();}},m("section.area-query-editor",m("div.grid-q-editor-datadict",{oncreate:function(vnode){const LayoutGrid=GridResize('.grid-q-editor-datadict','.area-q-splitter','.area-q-editor',`1fr 3px 1fr`,540,true);LayoutGrid.init();}},m("section.area-q-editor",m(QryForm)),m("div.area-q-splitter.splitter.splitter-vertical"),m("section.area-q-datadict",m(DataDict)),)),m("div.area-query-splitter.splitter.splitter-horizontal"),m("div",m("section.area-query-output-menu",m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab.tab-b",{class:App.tabState.selectedClass("result"),onclick:()=>App.tabState.set("result")},"result"),m("div.grid-col.tab.tab-b.ml-20",{class:App.tabState.selectedClass("explain"),onclick:()=>App.tabState.set("explain")},"explain"),m("div.grid-col.align-items-end.ml-auto",m(QryInfos)),),),m("section.area-query-output",m("div",{class:App.tabState.displayClass("result")},m(QryResult)),m("div",{class:App.tabState.displayClass("explain")},m(QryExplain)),)))]),m("footer.area-footer-content.ml-auto.mr-0.text-x-small",m("p",m.trust('<a href="https://github.com/a-le/'+versionInfo.appName+'" target="_blank">'+versionInfo.appName+'</a> &copy; 2024 . Licensed under AGPL. <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank">View License</a>'))));}};const ConnForm={conns:[],DBerror:"",connecting:false,oninit:()=>{m.request({method:"GET",url:"/api/config/cnxnames",}).then(function(response){ConnForm.conns=response.data;});},submitConnect:(conn)=>{ConnForm.connecting=true;m.request({method:"GET",url:"/api/connect/:conn",params:{conn:conn},headers:getRequestHeaders(),extract:getRequestExtract(),}).then(function(response){ConnForm.connecting=false;if(response.DBerror!==""){ConnForm.DBerror=response.DBerror;}
else{App.conn=conn;ConnInfos.get();SchemaForm.get();DataDict.getTables();DataDict.getViews();DataDict.getProcedures();}});},saveToLocalStorage:(k,v)=>{localStorage.setItem(App.conn+":"+k,v);},getFromLocalStorage:(k)=>{return localStorage.getItem(App.conn+":"+k);},view:()=>{return!ConnForm.conns?null:[m("select",{id:"connSelect",onchange:function(e){App.conn="";App.schema="";ConnForm.DBerror="";SchemaForm.reset();ConnInfos.reset();QryForm.reset();DataDict.reset();if(e.target.value===""){return;}
ConnForm.submitConnect(e.target.value);}},[m("option",{value:""},"select connection…"),m(OptGroup,{rows:ConnForm.conns})]),ConnForm.DBerror==""?null:[m("button.ml-10",{onclick:()=>{document.querySelector("#connSelect").dispatchEvent(new Event("change"));}},"retry to connect")],ConnForm.connecting?m(WaitingAnimation,{text:"connecting",class:"ml-10"}):null];}}
const ConnInfos={response:null,database:null,schema:null,user:null,version:null,reset:()=>{ConnInfos.response=null;ConnInfos.hostname=null;ConnInfos.port=null;ConnInfos.database=null;ConnInfos.schema=null;ConnInfos.user=null;ConnInfos.version=null;},get:()=>{if(App.conn===""){ConnInfos.reset();return;}
return m.request({method:"GET",url:"/api/command/:conn/:schema/conn-infos",headers:getRequestHeaders(),extract:getRequestExtract(),params:{conn:App.conn,schema:App.schema},}).then((result)=>{ConnInfos.response=result;if(result.DBerror)
return;let i=0;ConnInfos.hostname=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;ConnInfos.port=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;ConnInfos.database=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;ConnInfos.schema=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;ConnInfos.user=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;ConnInfos.version=!result.rows[0][i]?null:{"key":result.cols[i],"value":result.rows[0][i]};i++;})},view:()=>{return[!ConnInfos.response?null:[ConnInfos.response.DBerror?m("div.text-warning",ConnInfos.response.DBerror):[!ConnInfos.hostname?null:m("div.font-sm.mr-20",ConnInfos.hostname.key+": ",m("span.info",ConnInfos.hostname.value+(ConnInfos.port.value?":"+ConnInfos.port.value:""))),!ConnInfos.database?null:m("div.font-sm.mr-20",ConnInfos.database.key+": ",m("span.info",{title:ConnInfos.database.value},ConnInfos.database.value.split(/[/\\]/).pop())),!ConnInfos.user?null:m("div.font-sm.mr-20",ConnInfos.user.key+": ",m("span.info",ConnInfos.user.value)),!ConnInfos.schema?null:m("div.font-sm.mr-20",ConnInfos.schema.key+": ",m("span.info",ConnInfos.schema.value)),!ConnInfos.version?null:m("div.font-sm.mr-20.no-overflow",{style:"max-width: 220px;"},ConnInfos.version.key+": ",m("span.info",{title:ConnInfos.version.value},ConnInfos.version.value))]]];}};class Dict{constructor(){this.selected="";this.list=null;this.definition=null;this.columns=null;}
changeItem(item){if(this.selected==item)
return false;this.selected=item;this.definition=null;this.columns=null;if(item==="")
return false;return true;}}
const DataDict={tables:new Dict(),views:new Dict(),procedures:new Dict(),activity:new Dict(),tabStates:{objects:new TabState(""),tables:new TabState("columns"),views:new TabState("columns")},reset:()=>{DataDict.tables=new Dict();DataDict.views=new Dict();DataDict.procedures=new Dict();DataDict.activity=new Dict();DataDict.tabStates={objects:new TabState(""),tables:new TabState("columns"),views:new TabState("columns")};},getCommandOptions(command,args){return{method:"GET",url:"/api/command/:conn/:schema/:command",headers:getRequestHeaders(),extract:getRequestExtract(),params:{conn:App.conn,schema:App.schema,command:command,args:args},};},getTables:()=>{let command="tables",args=[];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.tables.list=response;});},getViews:()=>{let command="views",args=[];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.views.list=response;});},getProcedures:()=>{let command="procedures",args=[];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.procedures.list=response;});},getTableInfos:(item)=>{if(!DataDict.tables.changeItem(item))
return;let command="table-columns",args=[item];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.tables.columns=response;});command="table-definition",args=[item];opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.tables.definition=response;});},getViewInfos:(item)=>{if(!DataDict.views.changeItem(item))
return;let command="view-columns",args=[item];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.views.columns=response;});command="view-definition",args=[item];opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.views.definition=response;});},getProcedureInfos:(item)=>{if(!DataDict.procedures.changeItem(item))
return;let command="procedure-definition",args=[item];let opts=DataDict.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDict.procedures.definition=response;});},getActivityInfos:()=>{let command="activity";let opts=DataDict.getCommandOptions(command,[]);m.request(opts).then((response)=>{DataDict.activity.columns=response;});},view:()=>{return m("div[id=datadict].grid",{style:"grid-template-columns: auto 1fr; padding-top: 5px;"},m("div.datadict",!DataDict.tables.list?null:[m("div.tab.tab-l",{class:DataDict.tabStates.objects.selectedClass("table"),onclick:()=>{DataDict.tabStates.objects.set("table")},},m('label',{for:"tableSel",},"tables ("+DataDict.tables.list.rows.length+"): "),m("select[id=tableSel]",{size:1,disabled:!DataDict.tables.list.rows.length,onchange:function(e){DataDict.getTableInfos(e.target.value);}},m("option",{value:""},""),DataDict.tables.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!DataDict.views.list?null:[m("div.tab.tab-l.mt-10",{class:DataDict.tabStates.objects.selectedClass("view"),onclick:()=>{DataDict.tabStates.objects.set("view")},},m('label',{for:"viewSel",},"views ("+DataDict.views.list.rows.length+"): "),m("select[id=viewSel]",{size:1,disabled:!DataDict.views.list.rows.length,onchange:(e)=>{DataDict.getViewInfos(e.target.value);}},m("option",{value:""},""),DataDict.views.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!DataDict.procedures.list?null:[m("div.tab.tab-l.mt-10",{class:DataDict.tabStates.objects.selectedClass("procedure"),onclick:()=>{DataDict.tabStates.objects.set("procedure")},},m('label',{for:"procedureSel",},"procedures ("+DataDict.procedures.list.rows.length+"): "),m("select",{id:"procedureSel",size:1,disabled:!DataDict.procedures.list.rows.length,onchange:function(e){DataDict.getProcedureInfos(e.target.value);}},m("option",{value:""},""),DataDict.procedures.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!App.conn?null:[m("div.tab.tab-l.mt-10",{class:DataDict.tabStates.objects.selectedClass("activity"),onclick:()=>{DataDict.tabStates.objects.set("activity")},},m('label',{for:"activityBtn",},"activity"),m("button",{id:"activityBtn",onclick:()=>{DataDict.getActivityInfos();}},"activity"))]),m("div[id=dataDictDef].comptext.ml-10",{style:"overflow-y: auto;"},!DataDict.tabStates.objects.is("table")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab",{class:DataDict.tabStates.tables.selectedClass("columns"),onclick:()=>{DataDict.tabStates.tables.set("columns")},},"columns"),m("div.grid-col.tab.ml-10",{class:DataDict.tabStates.tables.selectedClass("definition"),onclick:()=>{DataDict.tabStates.tables.set("definition")},},"definition")),m("div",m("div",{class:DataDict.tabStates.tables.displayClass("columns")},m(DictColumns,{resp:DataDict.tables.columns,selected:DataDict.tables.selected})),m("div",{class:DataDict.tabStates.tables.displayClass("definition")},m(DictCode,{resp:DataDict.tables.definition,selected:DataDict.tables.selected})))],!DataDict.tabStates.objects.is("view")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab",{class:DataDict.tabStates.views.selectedClass("columns"),onclick:()=>{DataDict.tabStates.views.set("columns")},},"columns"),m("div.grid-col.tab.ml-10",{class:DataDict.tabStates.views.selectedClass("definition"),onclick:()=>{DataDict.tabStates.views.set("definition")},},"definition")),m("div",m("div",{class:DataDict.tabStates.views.displayClass("columns")},m(DictColumns,{resp:DataDict.views.columns,selected:DataDict.views.selected})),m("div",{class:DataDict.tabStates.views.displayClass("definition")},m(DictCode,{resp:DataDict.views.definition,selected:DataDict.views.selected})))],!DataDict.tabStates.objects.is("procedure")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab.selected","definition"),),m("div",m(DictCode,{resp:DataDict.procedures.definition,selected:DataDict.procedures.selected}))],!DataDict.tabStates.objects.is("activity")?null:[m("div",m(DictColumns,{resp:DataDict.activity.columns,selected:"activity"}))]))}}
const DictColumns={tableDim:null,resizeObserver:null,rowsSample:null,view:(vnode)=>{const resp=vnode.attrs.resp;const selected=vnode.attrs.selected;if(resp?.rows?.length){DictColumns.rowsSample=resp.rows.slice(0,10).concat([resp.cols]);let availableWidth=document.querySelector('#dataDictDef').clientWidth-7;DictColumns.tableDim=new TableDim().setRows(DictColumns.rowsSample).setCharWidth(6.5).setAvailableWidth(availableWidth).setTdPadding(10).calc();}
return[!resp?null:[resp.DBerror?m("div.text-warning",resp.DBerror):m("table",{style:{width:(DictColumns.tableDim.getTotalWidth())+"px"},oninit:()=>{DictColumns.resizeObserver=new ResizeObserver(entries=>{window.requestAnimationFrame(()=>{DictColumns.tableDim.setAvailableWidth(entries[0].contentRect.width).calc();m.redraw();});});},oncreate:()=>{DictColumns.resizeObserver.observe(document.querySelector('#dataDictDef'));},onremove:()=>{DictColumns.resizeObserver.disconnect();}},[m("caption",selected),m("thead",[m("tr",[resp.cols.map(function(v,idx){return m("th",{style:"width: "+DictColumns.tableDim.getColWidth(idx)+"px;"},v);})])]),m("tbody",[resp.rows.map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:resp.databaseType[i]});}));})])])]]}}
const DictCode={view:(vnode)=>{const resp=vnode.attrs.resp;const selected=vnode.attrs.selected;let code="";if(resp?.rows?.length){if(resp.cols.length>1&&resp.rows.length==1){for(var i=0;i<resp.cols.length;i++){if(resp.cols[i].toLowerCase().startsWith("create")){code=resp.rows[0][i];break;}}}
else if(resp.cols.length===1&&resp.rows.length>1){for(var i=0;i<resp.rows.length;i++){code+=resp.rows[i][0];}}
if(code==="")code=resp.rows[0][0];}
return[resp?.DBerror?m("div.text-warning.mt-10",resp.DBerror):code===""?null:m("table",[m("caption",selected),m("tbody",[m("tr",m("td",m("code",{id:"viewDef",oncreate:function(vnode){resp.editorTheme=App.theme;resp.editor=new SqlEditor(vnode.dom.id,isLightTheme(App.theme)?'light':'dark');resp.editor.setReadOnly(true);resp.editor.setCode(code);},onbeforeupdate:function(){if(resp.editorTheme!==App.theme){if(isLightTheme(App.theme))resp.editor.setLightTheme();else resp.editor.setDarkTheme();resp.editorTheme=App.theme;}
return false;},},null)))])])]}}
const QryExplain={query:"",resp:null,reset:()=>{QryExplain.query=null;QryExplain.resp=null;},submit:()=>{QryExplain.resp=null;QryExplain.query=QryForm.editor.getCode().trim();if(!QryExplain.query.length){return;}
var formData=new FormData();formData.set("conn",App.conn);formData.set("schema",App.schema);formData.set("query",QryExplain.query);formData.set("statementType","query");formData.set("explain","1");m.request({method:"POST",url:"/api/query",headers:getRequestHeaders(),extract:getRequestExtract(),body:formData,}).then(function(response){QryForm.executing=false;QryExplain.resp=response;});},view:()=>{return[!QryExplain.resp?null:QryExplain.resp.DBerror!==""?QryExplain.resp.DBerror:m("table.comptext",[m("thead",[m("tr",[QryExplain.resp.rows.length?QryExplain.resp.cols.map(function(v){return m("th",v);}):null])]),m("tbody",[QryExplain.resp.rows.map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:QryExplain.resp.databaseType[i]})}));})])])]}}
const QryForm={query:"",resp:null,exportType:"",statementType:"",resizeObserver:null,editor:null,editorTheme:"",xhr:null,executing:false,callError:false,reset:()=>{QryForm.query="";QryForm.resp=null;QryForm.currentPage=0;QryExplain.reset();QryInfos.reset();},submitQuery:()=>{QryForm.resp=null;QryForm.currentPage=0;QryForm.query=QryForm.editor.getCode().trim();ConnForm.saveToLocalStorage('lastQuery',QryForm.query);if(!QryForm.query.length){return;}
QryForm.executing=true;var formData=new FormData();formData.set("conn",App.conn);formData.set("schema",App.schema);formData.set("query",QryForm.query);formData.set("statementType",QryForm.statementType);m.request({method:"POST",url:"/api/query",headers:getRequestHeaders(),extract:getRequestExtract(),config:function(xhr){QryForm.xhr=xhr;},body:formData,}).then((response)=>{QryForm.executing=false;QryForm.callError=null;QryResult.currentPage=0;QryForm.resp=response;QryForm.resp.duration=Math.ceil(QryForm.resp.duration/1e+6);}).catch((e)=>{QryForm.executing=false;QryForm.callError=e.code?e.code+": "+e.message:"no error message. The server did not respond.";});},view:()=>{return ConnForm.DBerror!==""?m('code.text-warning',ConnForm.DBerror):!App.conn.length?null:[m("code[id=query-code]",{onclick:()=>{QryForm.editor.setFocusInitial();},oninit:(vnode)=>{var qryFormMenuHeight=58;var datadictMgBtm=2;QryForm.resizeObserver=new ResizeObserver(entries=>{vnode.dom.style.height=entries[0].contentRect.height-qryFormMenuHeight+'px';document.querySelector('section.area-q-datadict > :first-child').style.height=entries[0].contentRect.height-datadictMgBtm+'px';});},oncreate:(vnode)=>{QryForm.editorTheme=App.theme;QryForm.editor=new SqlEditor(vnode.dom.id,isLightTheme(App.theme)?'light':'dark');QryForm.editor.setCode(ConnForm.getFromLocalStorage('lastQuery')||'');QryForm.editor.setFocusInitial();QryForm.resizeObserver.observe(document.querySelector('.area-query-editor'));},onbeforeupdate:()=>{if(QryForm.editorTheme!==App.theme){if(isLightTheme(App.theme))QryForm.editor.setLightTheme();else QryForm.editor.setDarkTheme();QryForm.editorTheme=App.theme;}
return false;},onremove:()=>{QryForm.resizeObserver.disconnect();}}),m("div[id=qryFormMenu]",{style:"padding: 0 6px;"},m("fieldset",m("legend","download results"),m("form",{method:"POST",action:"/api/export",target:"exportPopup",onsubmit:(e)=>{let query=QryForm.editor.getCode();e.target.elements["query"].value=query;if(query.trim()==="")return false;let popup=window.open('','exportPopup','width=600,height=400');let content='<html><head><title>Export in progress</title><meta name="color-scheme" content="light dark"></head>'
+'<body><h2>Processing your export...</h2><button type=button onclick=window.close()>Close</button></body></html>';popup.document.write(content);popup.onload=()=>{popup.close();};return true;}},m("select[name=exportType][required]",{title:"choose file format to export to"},m("option",{value:"csv"},".csv file"),m("option",{value:"xlsx"},".xlsx file"),),m('input[name=conn][type="hidden"]',{value:App.conn}),m('input[name=schema][type="hidden"]',{value:App.schema}),m('input[name=query][type="hidden"]'),m("button[type=submit].ml-10",{title:"execute query and download results",disabled:QryForm.executing,},"download"),),),m("div",{style:"float: right;"},m("fieldset.ml-20",m("legend","explain query"),m("button[type=button]",{disabled:QryForm.executing,onclick:()=>{QryExplain.submit();App.tabState.set("explain");}},"explain"),),m("fieldset.ml-20",m("legend","execute query"),m("select[name=statementType]",{title:"'auto' || 'query' to return rows || 'exec' to return number of affected rows",onchange:(e)=>{QryForm.statementType=e.target.value}},m("option",{value:"auto"},"auto"),m("option",{value:"query"},"query"),m("option",{value:"exec"},"exec"),),m("button[type=button].ml-10",{disabled:QryForm.executing,onclick:()=>{QryForm.submitQuery();App.tabState.set("result");}},"execute"),m("button[type=button]",{title:"abort execution",disabled:!QryForm.executing,onclick:()=>{QryForm.xhr.abort();QryForm.xhr=null;QryForm.executing=false;}},"■"),),)),];}}
const QryInfos={rowsAffected:"",duration:"",truncated:false,clockResolution:null,oninit:()=>{return m.request({method:"GET",url:"/api/clockresolution"}).then(function(result){QryInfos.clockResolution=Math.ceil(result.data/1e+6)+" ms";})},reset:()=>{QryInfos.rowsAffected="";QryInfos.duration="";QryInfos.truncated=false;},view:()=>{QryInfos.rowsAffected=!QryForm.resp?"":QryForm.resp.rowsAffected;QryInfos.duration=!QryForm.resp?"":(QryForm.resp.duration==0?"<"+QryInfos.clockResolution:QryForm.resp.duration)+" ms";QryInfos.truncated=!QryForm.resp?false:QryForm.resp.truncated;return[!QryInfos.duration?null:[m("div.tab-addon.font-sm.mr-20",{style:"min-width: 130px; "},"rows affected: ",m('span.info',{class:QryInfos.truncated?"text-warning":"",title:QryInfos.truncated?"The result is truncated. Use export to get the full result.":"",},QryInfos.rowsAffected+(QryInfos.truncated?"+":""))),m("div.tab-addon.font-sm.mr-20","duration: ",m("span.info",QryInfos.duration)),]];}};const QryResult={currentPage:0,pageSize:15,initPagination:()=>{const totalRows=QryForm.resp&&QryForm.resp.rows?QryForm.resp.rows.length:0;const totalPages=Math.ceil(totalRows/QryResult.pageSize);const startIndex=QryResult.currentPage*QryResult.pageSize;const endIndex=startIndex+QryResult.pageSize;const setPage=function(page){if(page>=0&&page<totalPages){QryResult.currentPage=page;}};return{totalRows,totalPages,startIndex,endIndex,setPage};},view:()=>{if(QryForm.resp){var{totalPages,startIndex,endIndex,setPage}=QryResult.initPagination();var tableDim=new TableDim();tableDim.setRows(QryForm.resp.rows.slice(0,10).concat([QryForm.resp.cols])).setCharWidth(6.5).setAvailableWidth(document.body.clientWidth+ -30).setTdPadding(10+2).calc();}
return[QryForm.executing?m(WaitingAnimation,{text:"waiting for results"}):QryForm.callError?m("div.text-warning","error: "+QryForm.callError):!QryForm.resp?null:QryForm.resp.DBerror!==""?QryForm.resp.DBerror:[m("div.mt-5",{style:"height: "+(totalPages?"260px":"auto")},m("table.comptext",{style:"width: "+tableDim.getTotalWidth()+"px;"},[m("thead",[m("tr",[QryForm.resp.cols.map(function(v,idx){return m("th",{title:v,style:"width: "+tableDim.getColWidth(idx)+"px;"},v);})])]),m("tbody",[QryForm.resp.rows.slice(startIndex,endIndex).map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:QryForm.resp.databaseType[i]});}));})])])),!totalPages?null:m("div.mt-5.tac",m("button",{onclick:function(){setPage(QryResult.currentPage-1);},disabled:QryResult.currentPage===0},"Previous"),m("span.ml-10","Page "+(QryResult.currentPage+1)+" of "+Math.max(totalPages,1)),m("button.ml-10",{onclick:function(){setPage(QryResult.currentPage+1);},disabled:QryResult.currentPage===totalPages-1},"Next"))]]}}
const SchemaForm={schemas:null,reset:()=>{SchemaForm.schemas=null;},get:()=>{m.request({method:"GET",url:"/api/command/:conn/:schema/:command",params:{conn:App.conn,schema:App.schema,command:"schemas"}}).then(function(response){SchemaForm.schemas=response;});},view:()=>{return[!SchemaForm.schemas?null:!SchemaForm.schemas.rows.length?null:m("select",{name:"schema-select",title:"eventually set a schema or database.",onchange:function(e){App.schema=e.target.value;QryForm.reset();QryExplain.reset();DataDict.reset();ConnInfos.get();DataDict.getTables();DataDict.getViews();DataDict.getProcedures();}},[m("option",{value:""},"default"),SchemaForm.schemas.rows.map(function(row){return[m("option",{value:row[0],selected:App.schema===row[0]},row[0])];})])];}}