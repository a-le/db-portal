const ThemeSwitch={view:()=>{return m("div.toggle-switch",{title:"Light/Dark Mode"},m("label.switch",m("input",{type:"checkbox",name:"lightswitch",oncreate:function(vnode){vnode.dom.checked=isLightTheme(App.theme);},onclick:function(e){App.theme=(e.target.checked?"light-mode":"dark-mode");localStorage.setItem("theme",App.theme);}}),m("span.slider")));}}
const GridResize=(gridSelector,gutterSelector,areaSelector,gridTemplate,minSize=100,isColumn=false)=>{const grid=document.querySelector(gridSelector);const gutter=document.querySelector(gutterSelector);const area=grid.querySelector(areaSelector);let isDragging=false;let startPosition=0;let startAreaSize=0;let originalSize=0;function setNoSelect(state){state?document.body.classList.add('no-select'):document.body.classList.remove('no-select');}
const onMouseDown=(e)=>{isDragging=true;startPosition=isColumn?e.clientX:e.clientY;startAreaSize=isColumn?area.offsetWidth:area.offsetHeight;document.body.style.cursor=isColumn?'col-resize':'row-resize';setNoSelect(true);};const onMouseMove=(e)=>{if(!isDragging)return;const delta=isColumn?(e.clientX-startPosition):(e.clientY-startPosition);let newAreaSize=startAreaSize+delta;newAreaSize=Math.max(newAreaSize,minSize);const currentSizes=grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows'].split(' ');currentSizes[0]=`${newAreaSize}px`;grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows']=currentSizes.join(' ');};const onMouseUp=()=>{isDragging=false;document.body.style.cursor='';setNoSelect(false);};const onDoubleClick=()=>{const currentSizes=grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows'].split(' ');currentSizes[0]=`${originalSize}px`;grid.style[isColumn?'gridTemplateColumns':'gridTemplateRows']=currentSizes.join(' ');};return{init:()=>{if(isColumn){grid.style.gridTemplateColumns=gridTemplate;originalSize=area.offsetWidth;}else{grid.style.gridTemplateRows=gridTemplate;originalSize=area.offsetHeight;}
gutter.addEventListener('mousedown',onMouseDown);gutter.addEventListener('dblclick',onDoubleClick);document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);},destroy:()=>{gutter.removeEventListener('mousedown',onMouseDown);gutter.removeEventListener('dblclick',onDoubleClick);document.removeEventListener('mousemove',onMouseMove);document.removeEventListener('mouseup',onMouseUp);}};};class UIState{constructor({def,onSet}={}){this.current=def;this.onSet=typeof onSet==="function"?onSet:null;}
set(name){this.current=name;if(this.onSet)this.onSet(name);}
get(){return this.current;}
is(name){return(this.current===name);}
selectedClass(name){return(this.current===name)?"selected":"";}
displayClass(name){return(this.current===name)?"":"display-none";}}
class TableDim{constructor(){this.rows=[[]];this.charWidth=6.5;this.availableWidth=0;this.tdPadding=12;this.colWidths=new Map();this.totalWidth=0;}
setRows(newRows){this.rows=newRows;return this;}
setCharWidth(newCharWidth){this.charWidth=newCharWidth;return this;}
setAvailableWidth(newAvailableWidth){this.availableWidth=newAvailableWidth;return this;}
setTdPadding(newTdPadding){this.tdPadding=newTdPadding;return this;}
getColWidths(){return this.colWidths;}
getColWidth(colIdx){return Math.floor(this.colWidths.get(colIdx));}
getTotalWidth(){return this.totalWidth;}
calc(){const maxColLengths=new Map();this.colWidths=new Map();this.totalWidth=0;this.rows.forEach(row=>{row.forEach((col,idx)=>{var len=0;if(col==null)len=4;else if(typeof col=="object")len=JSON.stringify(col).length;else len=String(col).length;len=Math.max(len,2);if(!maxColLengths.has(idx)||len>maxColLengths.get(idx)){maxColLengths.set(idx,len);}});});let remainingWidth=this.availableWidth;outerLoop:while(maxColLengths.size>0){const evenlyDistributedWidth=Math.floor(remainingWidth/maxColLengths.size);for(const[idx,maxLen]of maxColLengths){const idealWidth=maxLen*this.charWidth+this.tdPadding;if(idealWidth<=evenlyDistributedWidth){this.colWidths.set(idx,idealWidth);remainingWidth-=idealWidth;maxColLengths.delete(idx);continue outerLoop;}}
for(const[idx]of maxColLengths){const evenlyWidth=Math.floor(remainingWidth/maxColLengths.size);this.colWidths.set(idx,evenlyWidth);remainingWidth-=evenlyWidth;maxColLengths.delete(idx);}
break;}
if(remainingWidth>this.colWidths.size){let usedWidth=0;for(const[,v]of this.colWidths){usedWidth+=v;}
const addWidth=Math.floor(Math.min(remainingWidth/this.colWidths.size,usedWidth*0.2/this.colWidths.size));for(const[k,v]of this.colWidths){this.colWidths.set(k,v+addWidth);}}
for(const[,v]of this.colWidths){this.totalWidth+=v;}
return this;}}
const Cell={classTar(type){t=type.toLowerCase();return["string","name","text","unknown"].includes(t)||t.includes("char")?"":"tar";},classCell(val){if(val===null)return"cell-null";if(val===true)return"cell-true";if(val===false)return"cell-false";return"";},displayValue(val){if(val===null)return"null";if(val===true)return"true";if(val===false)return"false";if(typeof val=="object")return JSON.stringify(val);return val;},setTitleFromInnerText(e){if(e.currentTarget.title==="")e.currentTarget.title=e.currentTarget.innerText;},view:(vnode)=>{var displayVal=Cell.displayValue(vnode.attrs.val);return m("td",m("div",{onmouseover:(e)=>{Cell.setTitleFromInnerText(e);},class:[Cell.classTar(vnode.attrs.type),Cell.classCell(displayVal)].join(" "),},Cell.displayValue(displayVal)))}}
const isLightTheme=(theme)=>{return theme.toLowerCase().includes('light');}
function WaitingAnimation(vnode){const animationState={baseText:vnode.attrs.text||"processing",repeatChar:vnode.attrs.repeatChar||".",dots:0,displayText:""};const startAnimation=()=>{animationState.interval=setInterval(()=>{animationState.dots=(animationState.dots+1)%4;animationState.displayText=animationState.baseText+animationState.repeatChar.repeat(animationState.dots);m.redraw();},500);};const stopAnimation=()=>{clearInterval(animationState.interval);};return{oncreate:startAnimation,onremove:stopAnimation,view:()=>m("span",{class:vnode.attrs.class},animationState.displayText||animationState.baseText)};}
function parseJwt(token){const base64Url=token.split('.')[1];const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');const jsonPayload=decodeURIComponent(atob(base64).split('').map(function(c){return'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2);}).join(''));return JSON.parse(jsonPayload);}
function toSelectOptions(rows,emptyName,valueCol,labelCol,groupCol){const options=[];if(emptyName!==false){options.push({value:"",label:emptyName,});}
options.push(...(rows||[]).map(u=>({value:u[valueCol],label:u[labelCol],group:u[groupCol]})));return options;}
const OptGroup={view:({attrs:{rows,groupColname,contentColname,valueColname}})=>{if(!Array.isArray(rows)||!groupColname||!contentColname||!valueColname)return null;const groups=rows.reduce((acc,row)=>{const group=row[groupColname]||"";if(!acc[group])acc[group]=[];acc[group].push(row);return acc;},{});return Object.entries(groups).map(([group,items])=>group?m("optgroup",{label:group},items.map(item=>m("option",{value:item[valueColname]},item[contentColname]))):items.map(item=>m("option",{value:item[valueColname]},item[contentColname])));}};function DataSourceInput(){return{dsNames:[],error:"",connecting:false,getDataSources:function(){m.request({method:"GET",url:"/api/users/:username/data-sources",params:{username:App.getUsername()},headers:App.getAuthHeaders(),}).then((response)=>{this.dsNames=response.data;});},testDataSource:function(dsName,onSuccess){this.connecting=true
this.error=""
m.request({method:"GET",url:"/api/users/:username/data-sources/:dsName/test",params:{username:App.getUsername(),dsName:dsName},headers:App.getAuthHeaders(),}).then((response)=>{this.connecting=false;if(onSuccess)onSuccess(dsName,response)}).catch((e)=>{this.connecting=false;this.error=e.response.error})},oninit:function(){this.getDataSources()},view:function(vnode){if(!this.dsNames.length)
return null;const{onConnect,onChange,namePrefix,value=""}=vnode.attrs||{};const name=namePrefix?`${namePrefix}[dsName]`:"dsName";const options=toSelectOptions(this.dsNames,"select data source…","name","name","vendor");return[m(SelectInput,{name,value,options,onchange:(e)=>{this.error="";this.connecting=false;const val=e.target.value;if(onChange)onChange(val);if(val==="")return;this.testDataSource(val,onConnect);},onfocus:()=>{this.getDataSources();}}),this.error&&m("span.error.ml-10",this.error),this.connecting&&m(WaitingAnimation,{text:"connecting",class:"ml-10"})];}};}
function SchemaInput(){return{schemas:null,reset:function(){this.schemas=null;},getSchemas:function(dsName,schema){if(dsName==="")
return this.reset();const params={dsName,command:"schemas"};if(schema!==""){params.schema=schema;}
m.request({method:"GET",url:schema?"/api/command/:dsName/:schema/:command":"/api/command/:dsName/:command",headers:App.getAuthHeaders(),params,}).then((response)=>{this.schemas=response.data;});},view:function(vnode){if(!this.schemas||!this.schemas.rows.length)
return null;const{schema,onChange,namePrefix,value=""}=vnode.attrs||{};const name=namePrefix?`${namePrefix}[schema]`:"schema-select";return m("select",{name,value,title:"optionnaly set a schema or database…",onchange:(e)=>{if(onChange)onChange(e.target.value);}},[m("option",{value:""},""),this.schemas.rows.map(row=>m("option",{value:row[0]},row[0]))]);}};}
function TableInput(){return{tables:null,reset:function(){this.tables=null},getTables:function(dsName,schema){if(dsName==="")
return this.reset()
const params={dsName,command:"tables"};if(schema&&schema!=="")
params.schema=schema
m.request({method:"GET",url:schema?"/api/command/:dsName/:schema/:command":"/api/command/:dsName/:command",headers:App.getAuthHeaders(),params}).then((response)=>{this.tables=response.data});},view:function(vnode){if(!this.tables||!this.tables.rows.length)
return null
const{onChange,namePrefix,value=""}=vnode.attrs||{}
const name=namePrefix?`${namePrefix}[table]`:"table-select"
const options=[{value:"",label:"select table…"},...this.tables.rows.map(row=>({value:row[0],label:row[0]}))]
return m(SelectInput,{name,value,options,title:"select a table.",onchange:(e)=>{if(onChange)onChange(e.target.value)}})}}}
function EndpointTypeInput(){return{view:function(vnode){const{onChange,endPointType="",value=""}=vnode.attrs||{};const name=endPointType?`${endPointType}[type]`:"endpoint-type-select";const options=[{value:"",label:"select type…"},{value:"table",label:"DB table"},...(endPointType==="origin"?[{value:"query",label:"SQL query"}]:[]),{value:"file",label:"File"}];return m(SelectInput(),{name,value,options,onchange:(e)=>{if(onChange)onChange(e.target.value);}});}};}
function FileInput(){return{fileInputEl:null,triggerFileInput:function(){if(this.fileInputEl)this.fileInputEl.click();},reset:function(){if(this.fileInputEl){this.fileInputEl.value="";}},view:function(vnode){const{onChange,namePrefix,format,filename=""}=vnode.attrs||{};const name=namePrefix?`${namePrefix}[file]`:"endpoint-type-select";let accept="";if(format){let ext=format;if(ext.length>4)ext=ext.slice(0,4);accept="."+ext;}
return[m("button[type=button]",{onclick:()=>this.triggerFileInput()},"Choose file..."),m("input[type=file]",{style:"display:none",name,accept,onchange:(e)=>{if(onChange)onChange(e.target.files[0],e);},oncreate:vnode=>{this.fileInputEl=vnode.dom;},title:"select a file"}),m("span.ml-10",filename),];}};}
function FileFormatInput(){return{view:function(vnode){const{onChange,namePrefix="",value=""}=vnode.attrs||{};const name=namePrefix?`${namePrefix}[format]`:"file-format";const options=[{value:"",label:"Select format…"},{value:"xlsx",label:"xlsx"},{value:"csv",label:"csv"},{value:"json",label:"json"},{value:"jsonTabular",label:"json tabular"}];return m(SelectInput(),{name,value,options,onchange:(e)=>{if(onChange)onChange(e.target.value);}});}};}
class DictInput{constructor(){this.selected="";this.list=null;this.definition=null;this.columns=null;}
changeItem(item){if(this.selected==item)
return false;this.selected=item;this.definition=null;this.columns=null;if(item==="")
return false;return true;}}
function SelectInput(){return{view:({attrs})=>{const grouped={};(attrs.options||[]).forEach(opt=>{const group=opt.group||"";if(!grouped[group])grouped[group]=[];grouped[group].push(opt);});return m("select",{name:attrs.name,required:attrs.required,onclick:attrs.onclick,onchange:attrs.onchange,onfocus:attrs.onfocus,value:attrs.value},Object.entries(grouped).map(([group,opts])=>{if(group===""){return opts.map(opt=>m("option",{value:opt.value},opt.label));}else{return m("optgroup",{label:group},opts.map(opt=>m("option",{value:opt.value},opt.label)));}}));}};}
function LogoutInput(){return{view:()=>{return[m("button[type=button].mb-5",{title:"logout "+App.getUsername(),onclick:function(){App.logout();}},"logout"),]}}}
const DSInfoSection={response:null,database:null,schema:null,user:null,version:null,error:null,reset:()=>{DSInfoSection.response=null;DSInfoSection.error=null;DSInfoSection.hostname=null;DSInfoSection.port=null;DSInfoSection.database=null;DSInfoSection.schema=null;DSInfoSection.user=null;DSInfoSection.version=null;},get:()=>{if(QueryPage.dsName===""){DSInfoSection.reset();return;}
let url,params;params={dsName:QueryPage.dsName};if(QueryPage.schema!==""){url="/api/command/:dsName/:schema/ds-info";params.schema=QueryPage.schema;}else{url="/api/command/:dsName/ds-info";}
return m.request({method:"GET",url,headers:App.getAuthHeaders(),params,}).then((r)=>{DSInfoSection.response=r.data;if(r.error)
return;let i=0;DSInfoSection.hostname=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;DSInfoSection.port=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;DSInfoSection.database=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;DSInfoSection.schema=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;DSInfoSection.user=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;DSInfoSection.version=!r.data.rows[0][i]?null:{"key":r.data.cols[i],"value":r.data.rows[0][i]};i++;})},view:()=>{return[!DSInfoSection.response?null:[DSInfoSection.error?m("div.text-warning",DSInfoSection.error):[!DSInfoSection.database?null:m("div.font-sm.mr-20",m("span",DSInfoSection.database.key+": "),m("span.info",{title:DSInfoSection.database.value},DSInfoSection.database.value.split(/[/\\]/).pop())),!DSInfoSection.schema?null:m("div.font-sm.mr-20",m("span",DSInfoSection.schema.key+": "),m("span.info",DSInfoSection.schema.value)),!DSInfoSection.user?null:m("div.font-sm.mr-20",m("span",DSInfoSection.user.key+": "),m("span.info",DSInfoSection.user.value)),!DSInfoSection.hostname?null:m("div.font-sm.mr-20",m("span",DSInfoSection.hostname.key+": "),m("span.info",DSInfoSection.hostname.value+(DSInfoSection.port.value?":"+DSInfoSection.port.value:""))),!DSInfoSection.version?null:m("div.font-sm.mr-20.no-overflow",{style:"max-width: 220px;"},m("span",DSInfoSection.version.key+": "),m("span.info",{title:DSInfoSection.version.value},DSInfoSection.version.value))]]];}};const QryInfosSection={rowsAffected:"",duration:"",truncated:false,clockResolution:null,oninit:()=>{return m.request({method:"GET",url:"/api/clock-resolution",headers:App.getAuthHeaders(),}).then(function(result){QryInfosSection.clockResolution=Math.ceil(result.data/1e+6)+" ms";})},reset:()=>{QryInfosSection.rowsAffected="";QryInfosSection.duration="";QryInfosSection.truncated=false;},view:()=>{QryInfosSection.rowsAffected=!QryForm.respData||QryForm.respData.DBerror!==""||QryForm.respData.stmtType==="query"?"-":QryForm.respData.rowsAffected;QryInfosSection.rowsReturned=!QryForm.respData||QryForm.respData.DBerror!==""||QryForm.respData.stmtType==="non-query"?"-":QryForm.respData.rowsReturned;QryInfosSection.duration=!QryForm.respData?"-":(QryForm.respData.duration==0?"<"+QryInfosSection.clockResolution:QryForm.respData.duration)+" ms";QryInfosSection.truncated=!QryForm.respData?false:QryForm.respData.truncated;return[!QryInfosSection.duration?null:[m("div.tab-addon.font-sm.mr-20",{style:"min-width: 130px; "},"rows returned: ",m('span.info',{class:QryInfosSection.truncated?"text-warning":"",title:QryInfosSection.truncated?"The result is truncated. Use export to get the full result.":"",},QryInfosSection.rowsReturned)),m("div.tab-addon.font-sm.mr-20",{style:"min-width: 130px; "},"rows affected: ",m("span.info",QryInfosSection.rowsAffected)),m("div.tab-addon.font-sm.mr-20","duration: ",m("span.info",QryInfosSection.duration)),]];}};const QryResultSection={currentPage:0,pageSize:15,initPagination:()=>{const totalRows=QryForm.respData&&QryForm.respData.rows?QryForm.respData.rows.length:0;const totalPages=Math.ceil(totalRows/QryResultSection.pageSize);const startIndex=QryResultSection.currentPage*QryResultSection.pageSize;const endIndex=startIndex+QryResultSection.pageSize;const setPage=function(page){if(page>=0&&page<totalPages){QryResultSection.currentPage=page;}};return{totalRows,totalPages,startIndex,endIndex,setPage};},view:()=>{if(QryForm.respData){var{totalPages,startIndex,endIndex,setPage}=QryResultSection.initPagination();var tableDim=new TableDim();tableDim.setRows(QryForm.respData.rows.slice(0,10).concat([QryForm.respData.cols])).setCharWidth(6.5).setAvailableWidth(document.body.clientWidth+ -30).setTdPadding(10+2).calc();}
if(QryForm.executing)
return m(WaitingAnimation,{text:"waiting for results"});if(QryForm.error)
return m("div.error","error: "+QryForm.error);if(QryForm.respData&&QryForm.respData.DBerror)
return m("div.error",QryForm.respData.DBerror);if(QryForm.respData){return[m("div",{style:"height: "+(totalPages?"260px":"auto")},m("table.comptext",{style:"width: "+tableDim.getTotalWidth()+"px;"},[m("thead",[m("tr",[QryForm.respData.cols.map(function(v,idx){return m("th",{title:v,style:"width: "+tableDim.getColWidth(idx)+"px;"},v);})])]),m("tbody",[QryForm.respData.rows.slice(startIndex,endIndex).map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:QryForm.respData.databaseTypes[i]});}));})])])),!totalPages?null:m("div.mt-5.tac",m("button",{onclick:function(){setPage(QryResultSection.currentPage-1);},disabled:QryResultSection.currentPage===0},"Previous"),m("span.ml-10","Page "+(QryResultSection.currentPage+1)+" of "+Math.max(totalPages,1)),m("button.ml-10",{onclick:function(){setPage(QryResultSection.currentPage+1);},disabled:QryResultSection.currentPage===totalPages-1},"Next"))]}}}
const DictColumnsSection={tableDim:null,resizeObserver:null,rowsSample:null,view:(vnode)=>{const resp=vnode.attrs.resp;const selected=vnode.attrs.selected;if(resp?.rows?.length){DictColumnsSection.rowsSample=resp.rows.slice(0,10).concat([resp.cols]);let availableWidth=document.querySelector('#dataDictDef').clientWidth-7;DictColumnsSection.tableDim=new TableDim().setRows(DictColumnsSection.rowsSample).setCharWidth(6.5).setAvailableWidth(availableWidth).setTdPadding(10).calc();}
return[!resp?null:[resp.DBerror?m("div.text-warning",resp.DBerror):m("table",{style:{width:(DictColumnsSection.tableDim.getTotalWidth())+"px"},oninit:()=>{DictColumnsSection.resizeObserver=new ResizeObserver(entries=>{window.requestAnimationFrame(()=>{DictColumnsSection.tableDim.setAvailableWidth(entries[0].contentRect.width).calc();m.redraw();});});},oncreate:()=>{DictColumnsSection.resizeObserver.observe(document.querySelector('#dataDictDef'));},onremove:()=>{DictColumnsSection.resizeObserver.disconnect();}},[m("caption",selected),m("thead",[m("tr",[resp.cols.map(function(v,idx){return m("th",{style:"width: "+DictColumnsSection.tableDim.getColWidth(idx)+"px;"},v);})])]),m("tbody",[resp.rows.map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:resp.databaseTypes[i]});}));})])])]]}}
const DictCodeSection={view:(vnode)=>{const resp=vnode.attrs.resp;const selected=vnode.attrs.selected;let code="";if(resp?.rows?.length){if(resp.cols.length>1&&resp.rows.length==1){for(var i=0;i<resp.cols.length;i++){if(resp.cols[i].toLowerCase().startsWith("create")){code=resp.rows[0][i];break;}}}
else if(resp.cols.length===1&&resp.rows.length>1){for(var i=0;i<resp.rows.length;i++){code+=resp.rows[i][0];}}
if(code==="")code=resp.rows[0][0];}
return[resp?.DBerror?m("div.text-warning.mt-10",resp.DBerror):code===""?null:m("table",[m("caption",selected),m("tbody",[m("tr",m("td",m("code",{id:"viewDef",oncreate:function(vnode){resp.editorTheme=App.theme;resp.editor=new SqlEditor(vnode.dom.id,isLightTheme(App.theme)?'light':'dark');resp.editor.setReadOnly(true);resp.editor.setCode(code);},onbeforeupdate:function(){if(resp.editorTheme!==App.theme){if(isLightTheme(App.theme))resp.editor.setLightTheme();else resp.editor.setDarkTheme();resp.editorTheme=App.theme;}
return false;},},null)))])])]}}
const QryExplainForm={query:"",respData:null,error:false,reset:()=>{QryExplainForm.query=null;QryExplainForm.respData=null;},submit:()=>{QryExplainForm.executing=true;QryExplainForm.error=null
QryExplainForm.respData=null;QryExplainForm.query=QryForm.editor.getCode().trim();if(!QryExplainForm.query.length){return;}
let url,params;params={dsname:QueryPage.dsName};if(QueryPage.schema!==""){url="/api/query/:dsname/:schema";params.schema=QueryPage.schema;}else{url="/api/query/:dsname";}
const formData=new FormData();formData.set("dsName",QueryPage.dsName);formData.set("schema",QueryPage.schema);formData.set("query",QryExplainForm.query);formData.set("statementType","query");formData.set("explain","1");m.request({method:"POST",url,params,headers:App.getAuthHeaders(),body:formData,}).then(function(response){QryExplainForm.executing=false;QryExplainForm.respData=response.data;}).catch((e)=>{QryExplainForm.executing=false
QryExplainForm.error=e.response.error;});},view:()=>{if(QryExplainForm.respData){var tableDim=new TableDim();tableDim.setRows(QryExplainForm.respData.rows.slice(0,10).concat([QryExplainForm.respData.cols])).setCharWidth(6.5).setAvailableWidth(document.body.clientWidth+ -30).setTdPadding(10+2).calc();}
if(QryExplainForm.executing)
return m(WaitingAnimation,{text:"waiting for results"});if(QryExplainForm.error)
return m("div.error","error: "+QryExplainForm.error);if(QryExplainForm.respData&&QryExplainForm.respData.DBerror)
return m("div.error",QryExplainForm.respData.DBerror);if(QryExplainForm.respData){return[m("table.comptext",{style:"width: "+tableDim.getTotalWidth()+"px;"},[m("thead",[m("tr",[QryExplainForm.respData.cols.map(function(v,idx){return m("th",{title:v,style:"width: "+tableDim.getColWidth(idx)+"px;"},v);})])]),m("tbody",[QryExplainForm.respData.rows.map(function(row){return m("tr",row.map(function(v,i){return m(Cell,{val:v,type:QryExplainForm.respData.databaseTypes[i]})}));})])])]}}}
function DataEndpointForm(){return{type:"",dsName:"",schema:"",table:"",tableMode:"existent",query:"",format:"",fileObject:null,FileInput:FileInput(),SchemaInput:SchemaInput(),TableInput:TableInput(),view:function(vnode){const{endPointType="origin"}=vnode.attrs||{}
if(App.dataTransferAction){App.dataTransferAction=false
this.type="query"
this.dsName=QueryPage.dsName
this.schema=QueryPage.schema
this.query=QryForm.editor.getCode().trim()
this.SchemaInput.getSchemas(this.dsName,this.schema)}
return m("table",[m("tr",[m("th","Type"),m("td.w-full",m(EndpointTypeInput,{value:this.type,endPointType,onChange:(sel)=>{this.format="";this.fileObject=null;if(["file",""].includes(sel)){this.dsName=this.schema="";this.SchemaInput.reset()
this.TableInput.reset()}
this.table=this.query=""
this.type=sel;}}))]),this.type==="file"?m("tr",[m("th","Format"),m("td",m(FileFormatInput,{value:this.format,namePrefix:endPointType,onChange:(sel)=>{if(endPointType==="origin"){this.fileObject=null
this.FileInput.reset()}
this.format=sel;}}))]):null,this.type==="file"&&endPointType==="origin"&&this.format?m("tr",[m("th","File"),m("td",m(this.FileInput,{filename:this.fileObject?this.fileObject.name:"",namePrefix:endPointType,format:this.format,onChange:(file)=>{this.fileObject=file;}}))]):null,this.type==="table"||this.type==="query"?[m("tr",[m("th","Data source"),m("td",m(DataSourceInput,{value:this.dsName,namePrefix:endPointType,onChange:(sel)=>{this.schema=this.table=""
this.dsName=sel;this.SchemaInput.getSchemas(this.dsName,this.schema)
this.TableInput.getTables(this.dsName,this.schema)}}))]),m("tr",[m("th","Schema"),m("td",m(this.SchemaInput,{value:this.schema,namePrefix:endPointType,dsName:this.dsName,onChange:(sel)=>{this.table="";this.schema=sel;this.TableInput.getTables(this.dsName,this.schema)}}))]),]:null,this.type==="table"?[m("tr",[m("th.pointer",{style:{opacity:this.tableMode=="existent"?1:.4},onclick:(e)=>{this.tableMode="existent"}},"Table"),m("td",this.tableMode=="existent"&&m(this.TableInput,{value:this.table,namePrefix:endPointType,dsName:this.dsName,schema:this.schema,onChange:(sel)=>{this.table=sel}}),)]),endPointType=="destination"&&m("tr",[m("th.pointer",{style:{opacity:this.tableMode=="new"?1:.4},title:"A new table will be created with column names and types matching the source (copy from).",onclick:(e)=>{this.tableMode="new"}},"New table"),m("td",this.tableMode=="new"&&this.dsName!=""&&[m('input',{oncreate:(vnode)=>{vnode.dom.focus();},type:"text",autocomplete:"off",placeholder:"A new table will be created",name:`${endPointType}[table]`,value:this.table,onchange:(e)=>{this.table=e.target.value;}}),m('pre.info.','Only DB table, DB query, or JSON tabular file as source are supported.\nOther cases are not yet implemented.'),m('input',{type:"hidden",name:`${endPointType}[isNewTable]`,value:"1"})])]),]:null,this.type==="query"?[m("tr",[m("th","SQL Query"),m("td",{style:"padding-right: 0"},m('textarea',{value:this.query,name:endPointType+"[query]",onchange:(e)=>{this.query=e.target.value}}))])]:null,]);}};}
const QryForm={query:"",respData:null,exportType:"",resizeObserver:null,editor:null,editorTheme:"",xhr:null,executing:false,error:false,selectedFileName:"",reset:()=>{QryForm.query=""
QryForm.respData=null
QryForm.currentPage=0
QryExplainForm.reset()
QryInfosSection.reset()},submitQuery:()=>{QryForm.respData=null
QryForm.currentPage=0
QryForm.error=null
QryForm.query=QryForm.editor.getCode().trim()
localStorage.setItem(["lastQuery",QueryPage.dsName].join("::"),QryForm.query)
if(!QryForm.query.length){return}
QryForm.executing=true
let url,params
params={dsname:QueryPage.dsName}
if(QueryPage.schema!==""){url="/api/query/:dsname/:schema"
params.schema=QueryPage.schema}else{url="/api/query/:dsname"}
const formData=new FormData()
formData.set("query",QryForm.query)
QryForm.xhr=new AbortController()
m.request({method:"POST",url,params,headers:App.getAuthHeaders(),body:formData,background:true,config:(xhr)=>{QryForm.xhr.signal.addEventListener('abort',()=>{xhr.abort()})}}).then((response)=>{QryForm.executing=false
QryForm.xhr=null
QryResultSection.currentPage=0
QryForm.respData=response.data
QryForm.respData.duration=Math.ceil(QryForm.respData.duration/1e+6)}).catch((e)=>{QryForm.executing=false
QryForm.xhr=null
QryForm.error=e.response.error;})},view:()=>{return[QueryPage.dsName.length&&[m("code[id=query-code]",{onclick:()=>{QryForm.editor.setFocusInitial()},oninit:(vnode)=>{var qryFormMenuHeight=58
var datadictMgBtm=2
QryForm.resizeObserver=new ResizeObserver(entries=>{vnode.dom.style.height=entries[0].contentRect.height-qryFormMenuHeight+'px'
document.querySelector('section.area-q-datadict > :first-child').style.height=entries[0].contentRect.height-datadictMgBtm+'px'})},oncreate:(vnode)=>{const lastQuery=localStorage.getItem(["lastQuery",QueryPage.dsName].join("::"))||''
QryForm.editorTheme=App.theme
QryForm.editor=new SqlEditor(vnode.dom.id,isLightTheme(App.theme)?'light':'dark')
QryForm.editor.setCode(lastQuery)
QryForm.editor.setFocusInitial()
QryForm.resizeObserver.observe(document.querySelector('.area-query-editor'))},onbeforeupdate:()=>{if(QryForm.editorTheme!==App.theme){if(isLightTheme(App.theme))QryForm.editor.setLightTheme()
else QryForm.editor.setDarkTheme()
QryForm.editorTheme=App.theme}
return false},onremove:()=>{QryForm.resizeObserver.disconnect()}}),m("div[id=qryFormMenu]",{style:"padding: 0 6px"},m("fieldset",m("legend","query execution"),m("button[type=button]",{disabled:QryForm.executing,onclick:()=>{QryExplainForm.submit()
QueryPage.tabState.set("explain")}},"explain"),m("button[type=button].ml-10",{disabled:QryForm.executing,onclick:()=>{QryExplainForm.reset()
QryForm.submitQuery()
QueryPage.tabState.set("result")}},"run query"),m("button[type=button]",{title:"Abort execution.",disabled:!QryForm.executing,onclick:()=>{QryForm.xhr.abort()
QryForm.xhr=null
QryForm.executing=false}},"■"),),m("fieldset",{style:"float: right"},m("legend",m.trust("&#8644 copy data")),m("button[type=button]",{title:"Navigate to the copy data panel with current settings.",disabled:QryForm.executing,onclick:()=>{App.dataTransferAction=true
App.pageState.set("copy")}},"set as source"),),),]]}}
const DataDictForm={tables:new DictInput(),views:new DictInput(),procedures:new DictInput(),activity:new DictInput(),tabStates:{objects:new UIState(),tables:new UIState({def:"columns"}),views:new UIState({def:"columns"})},reset:()=>{DataDictForm.tables=new DictInput();DataDictForm.views=new DictInput();DataDictForm.procedures=new DictInput();DataDictForm.activity=new DictInput();DataDictForm.tabStates={objects:new UIState(),tables:new UIState({def:"columns"}),views:new UIState({def:"columns"})};},getCommandOptions(command,args){let url,params;params={dsName:QueryPage.dsName,command:command};if(QueryPage.schema!=="")
params.schema=QueryPage.schema;url=QueryPage.schema?"/api/command/:dsName/:schema/:command":"/api/command/:dsName/:command"
if(args&&args.length){const qs=new URLSearchParams();args.forEach(a=>qs.append("args",a));url+="?"+qs.toString();}
return{method:"GET",url,headers:App.getAuthHeaders(),params,};},getTables:()=>{let command="tables",args=[];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.tables.list=response.data;});},getViews:()=>{let command="views",args=[];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.views.list=response.data;});},getProcedures:()=>{let command="procedures",args=[];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.procedures.list=response.data;});},getTableInfos:(item)=>{if(!DataDictForm.tables.changeItem(item))
return;let command="table-columns",args=[item];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.tables.columns=response.data;});command="table-definition",args=[item];opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.tables.definition=response.data;});},getViewInfos:(item)=>{if(!DataDictForm.views.changeItem(item))
return;let command="view-columns",args=[item];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.views.columns=response.data;});command="view-definition",args=[item];opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.views.definition=response.data;});},getProcedureInfos:(item)=>{if(!DataDictForm.procedures.changeItem(item))
return;let command="procedure-definition",args=[item];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.procedures.definition=response.data;});},getActivityInfos:()=>{let command="activity",args=[];let opts=DataDictForm.getCommandOptions(command,args);m.request(opts).then((response)=>{DataDictForm.activity.columns=response.data;});},view:()=>{return m("div[id=datadict].grid",{style:"grid-template-columns: auto 1fr;"},m("div.datadict",!DataDictForm.tables.list?null:[m("div.tab.tab-l",{class:DataDictForm.tabStates.objects.selectedClass("table"),onclick:()=>{DataDictForm.tabStates.objects.set("table");},},m('label',{for:"tableSel",title:"click to reload list",onclick:()=>{DataDictForm.getTables();}},"tables ("+DataDictForm.tables.list.rows.length+"): "),m("select[id=tableSel]",{size:1,disabled:!DataDictForm.tables.list.rows.length,onchange:function(e){DataDictForm.getTableInfos(e.target.value);}},m("option",{value:""},""),DataDictForm.tables.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!DataDictForm.views.list?null:[m("div.tab.tab-l.mt-5",{class:DataDictForm.tabStates.objects.selectedClass("view"),onclick:()=>{DataDictForm.tabStates.objects.set("view")},},m('label',{for:"viewSel",title:"click to reload list",onclick:()=>{DataDictForm.getViews()}},"views ("+DataDictForm.views.list.rows.length+"): "),m("select[id=viewSel]",{size:1,disabled:!DataDictForm.views.list.rows.length,onchange:(e)=>{DataDictForm.getViewInfos(e.target.value);},},m("option",{value:""},""),DataDictForm.views.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!DataDictForm.procedures.list?null:[m("div.tab.tab-l.mt-5",{class:DataDictForm.tabStates.objects.selectedClass("procedure"),onclick:()=>{DataDictForm.tabStates.objects.set("procedure")},},m('label',{for:"procedureSel",style:"white-space: nowrap;",title:"click to reload list",onclick:()=>{DataDictForm.getProcedures()}},"procedures ("+DataDictForm.procedures.list.rows.length+"): "),m("select",{id:"procedureSel",size:1,disabled:!DataDictForm.procedures.list.rows.length,onchange:function(e){DataDictForm.getProcedureInfos(e.target.value);},},m("option",{value:""},""),DataDictForm.procedures.list.rows.map((row)=>{return[m("option",{value:row[0]},row[0])];})))],!QueryPage.dsName?null:[m("div.tab.tab-l.mt-15",{class:DataDictForm.tabStates.objects.selectedClass("activity"),onclick:()=>{DataDictForm.tabStates.objects.set("activity")},},m("button",{onclick:()=>{DataDictForm.getActivityInfos();}},"activity"))]),m("div[id=dataDictDef].comptext.ml-10",{style:"overflow-y: auto;"},!DataDictForm.tabStates.objects.is("table")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab",{class:DataDictForm.tabStates.tables.selectedClass("columns"),onclick:()=>{DataDictForm.tabStates.tables.set("columns")},},"columns"),m("div.grid-col.tab.ml-10",{class:DataDictForm.tabStates.tables.selectedClass("definition"),onclick:()=>{DataDictForm.tabStates.tables.set("definition")},},"definition")),m("div",m("div",{class:DataDictForm.tabStates.tables.displayClass("columns")},m(DictColumnsSection,{resp:DataDictForm.tables.columns,selected:DataDictForm.tables.selected})),m("div",{class:DataDictForm.tabStates.tables.displayClass("definition")},m(DictCodeSection,{resp:DataDictForm.tables.definition,selected:DataDictForm.tables.selected})))],!DataDictForm.tabStates.objects.is("view")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab",{class:DataDictForm.tabStates.views.selectedClass("columns"),onclick:()=>{DataDictForm.tabStates.views.set("columns")},},"columns"),m("div.grid-col.tab.ml-10",{class:DataDictForm.tabStates.views.selectedClass("definition"),onclick:()=>{DataDictForm.tabStates.views.set("definition")},},"definition")),m("div",m("div",{class:DataDictForm.tabStates.views.displayClass("columns")},m(DictColumnsSection,{resp:DataDictForm.views.columns,selected:DataDictForm.views.selected})),m("div",{class:DataDictForm.tabStates.views.displayClass("definition")},m(DictCodeSection,{resp:DataDictForm.views.definition,selected:DataDictForm.views.selected})))],!DataDictForm.tabStates.objects.is("procedure")?null:[m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab.selected","definition"),),m("div",m(DictCodeSection,{resp:DataDictForm.procedures.definition,selected:DataDictForm.procedures.selected}))],!DataDictForm.tabStates.objects.is("activity")?null:[m("div",m(DictColumnsSection,{resp:DataDictForm.activity.columns,selected:"activity"}))]))}}
function LoginForm(){return{error:"",login:function(username,password){this.error="";if(!username||!password){this.error="Please enter both username and password.";return;}
m.request({method:"POST",url:"/api/auth/login",body:{username,password},}).then((resp)=>{if(!resp.token||resp.error){this.error=resp.error||"Login failed";}else{App.login(resp.token);}}).catch((e)=>{this.error=e.response.error||"Login failed";});},view:function(){return m("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:99}},[m("form",{onsubmit:(e)=>{e.preventDefault()
usernmame=e.target.elements["username"].value
password=e.target.elements["password"].value
this.login(usernmame,password)}},[m("fieldset",{style:"background-color: var(--primary-bg);"},m("legend","login"),m("div",[m("label",{for:"username"},"username"),m("input[type=text]",{id:"username",required:1,oncreate:vnode=>vnode.dom.focus()})]),m("div",[m("label",{for:"password"},"password"),m("input[type=password]",{id:"password",required:1,autocomplete:"off",})]),m("button[type=submit].mt-15","login"),m("div.error",this.error),),])]);}};}
const QueryPage={dsName:"",schema:"",tabState:new UIState({def:"result"}),SchemaInput:SchemaInput(),view:()=>{return[m("section.area-main-menu",m("div.grid",{style:"grid-template-columns: auto 1fr;"},m("div.grid-col",m("div",m(DataSourceInput,{value:QueryPage.dsName,onConnect:(dsName)=>{QueryPage.dsName=dsName;DSInfoSection.get();QueryPage.SchemaInput.getSchemas(QueryPage.dsName,QueryPage.schema);DataDictForm.getTables();DataDictForm.getViews();DataDictForm.getProcedures();},onChange:()=>{QueryPage.dsName="";QueryPage.schema="";QueryPage.SchemaInput.reset();DSInfoSection.reset();QryForm.reset();DataDictForm.reset();}})),m("div.ml-10",m(QueryPage.SchemaInput,{dsName:QueryPage.dsName,value:QueryPage.schema,onChange:(newSchema)=>{QueryPage.schema=newSchema;QryForm.reset();QryExplainForm.reset();DataDictForm.reset();DSInfoSection.get();DataDictForm.getTables();DataDictForm.getViews();DataDictForm.getProcedures();}})),m("div.grid-col.align-items-end.ml-10",m(DSInfoSection)),),),m("section.area-main-content",!QueryPage.dsName?null:[m("div.grid-query",{oncreate:function(vnode){var h0=document.querySelector('.grid-query').offsetHeight,h1=195,h2=335,h1=Math.max(h0-h2,h1);const LayoutGrid=GridResize('.grid-query','.area-query-splitter','.area-query-editor',`${h1}px 3px auto auto`,195,false);LayoutGrid.init();}},m("section.area-query-editor",m("div.grid-q-editor-datadict",{oncreate:function(vnode){const LayoutGrid=GridResize('.grid-q-editor-datadict','.area-q-splitter','.area-q-editor',`1fr 3px 1fr`,540,true);LayoutGrid.init();}},m("section.area-q-editor",m(QryForm)),m("div.area-q-splitter.splitter.splitter-vertical"),m("section.area-q-datadict",m(DataDictForm)),)),m("div.area-query-splitter.splitter.splitter-horizontal"),m("div",m("section.area-query-output-menu",m("div.grid",{style:"grid-template-columns: auto auto 1fr;"},m("div.grid-col.tab.tab-b",{class:QueryPage.tabState.selectedClass("result"),onclick:()=>QueryPage.tabState.set("result")},"result"),m("div.grid-col.tab.tab-b.ml-20",{class:QueryPage.tabState.selectedClass("explain"),onclick:()=>QueryPage.tabState.set("explain")},"explain"),m("div.grid-col.align-items-end.ml-50",m(QryInfosSection)),),),m("section.area-query-output",m("div",{class:QueryPage.tabState.displayClass("result")},m(QryResultSection)),m("div",{class:QueryPage.tabState.displayClass("explain")},m(QryExplainForm)),)))]))]}};function CopyDataPage(){return{origin:DataEndpointForm(),destination:DataEndpointForm(),getDestinationType:()=>{const sel=document.querySelector('select[name="destination[type]"]');return sel&&sel.value;},view:function(){const self=this;return m("form",{method:"POST",action:"/api/copy",target:"exportpage",enctype:"multipart/form-data",onsubmit:function(e){const popup=window.open('','exportpage','width=800,height=600');const message=self.getDestinationType()==="file"?"Preparing file. The download will start soon, please be patient...":"Copying data. A json report will be displayed when finished, please be patient..."
if(popup){popup.document.write(`<html><head><style>body { color: #222; background: #fff; }@media (prefers-color-scheme: dark) {body { color: #eee; background: #222; }}</style></head><body><div>${message}</div><button onclick="window.close()">Close</button></body></html>`);popup.document.close();}
e.target.setAttribute('target','exportpage');return true;}},[m("input[type=hidden][name=jwt]",{value:localStorage.getItem(JWT_KEY)}),m("fieldset.mb-20.w-600.h-130",{style:"display: block"},m("legend","Source (copy from)"),m(this.origin,{endPointType:"origin"})),m("fieldset.mb-20.w-600.h-130",{style:"display: block"},m("legend","Destination (copy to)"),m(this.destination,{endPointType:"destination"})),m("div.mb-20",m("button[type=submit]",{title:"copy data from origin to destination",disabled:this.executing},this.getDestinationType()==="file"?"download":"copy data")),this.getDestinationType()==="table"&&[m("strong","ℹ️ Transaction Safety"),m("pre",{style:"margin: 5px 0 0 0; font-size: 14px;"},"This copy operation uses a database transaction.\n If any error occurs during the process, "+"all changes will be automatically rolled back, leaving your destination table unchanged.\n "+"The copy will either complete successfully with all data, or fail completely with no partial data.")]]);}};}
function DatasourcesPage(){return{registeredDSs:[],notRegisteredDSs:[],users:[],vendors:[],usernameInput:"",vendorInput:"",locationInput:"",postUserDatasourcesError:"",postUsersError:"",addDSError:"",testDataSourceResult:"",getUsersDatasources:function(username){m.request({method:"GET",url:"/api/users/:username/data-sources",params:{username},headers:App.getAuthHeaders(),}).then((response)=>{this.registeredDSs=response.data||[];});},getUsersAvailableDatasources:function(username){m.request({method:"GET",url:"/api/users/:username/available-data-sources",params:{username},headers:App.getAuthHeaders(),}).then((response)=>{this.notRegisteredDSs=response.data||[];});},getUsers:function(){m.request({method:"GET",url:"/api/users",headers:App.getAuthHeaders(),}).then((response)=>{this.users=response.data||[];});},getVendors:function(){m.request({method:"GET",url:"/api/vendors",headers:App.getAuthHeaders(),}).then((response)=>{this.vendors=response.data||[];});},postDatasources:function(name,vendor,location){this.addDSError="";return m.request({method:"POST",url:"/api/data-sources",headers:App.getAuthHeaders(),body:{name,vendor,location}}).then(()=>{this.getUsersAvailableDatasources(this.usernameInput);}).catch((e)=>{this.addDSError=e.response.error;throw e;});},postUserDatasources:function(username,dsname){this.postUserDatasourcesError="";return m.request({method:"POST",url:"/api/users/:username/data-sources/:dsname",headers:App.getAuthHeaders(),params:{username,dsname}}).then((response)=>{this.getUsersDatasources(this.usernameInput);this.getUsersAvailableDatasources(this.usernameInput);}).catch((e)=>{this.postUserDatasourcesError=e.response.error;throw e;});},deleteUserDatasources:function(username,dsname){this.postUserDatasourcesError="";return m.request({method:"DELETE",url:"/api/users/:username/data-sources/:dsname",headers:App.getAuthHeaders(),params:{username,dsname}}).then(()=>{this.getUsersDatasources(this.usernameInput);this.getUsersAvailableDatasources(this.usernameInput);}).catch((e)=>{this.postUserDatasourcesError=e.response.error;throw e;});},postUsers:function(username,isadmin,password){this.postUsersError="";return m.request({method:"POST",url:"/api/users",headers:App.getAuthHeaders(),body:{username,isadmin,password}}).then(()=>{this.getUsers();}).catch((e)=>{this.postUsersError=e.response.error;throw e;});},testDataSource:function(vendor,location){return m.request({method:"POST",url:"/api/data-sources/test",headers:App.getAuthHeaders(),body:{vendor,location}}).then((resp)=>{this.testDataSourceResult=resp.error?resp.error:"connection test succeeded.";}).catch((e)=>{this.testDataSourceResult=e.response.error;throw e;});},oninit:function(){this.usernameInput=App.getUsername();this.postUserDatasourcesError="";this.postUsersError="";this.addDSError="";this.testDataSourceResult="";this.getUsers();this.getVendors();this.getUsersDatasources(this.usernameInput);this.getUsersAvailableDatasources(this.usernameInput);},view:function(){return[m("form.mt-20",{autocomplete:"off",onchange:()=>{this.postUsersError="";},onsubmit:(e)=>{e.preventDefault();const username=e.target.elements["username"].value;const dsname=e.target.elements["dsname"].value;this.postUserDatasources(username,dsname).then(()=>{e.target.reset();});}},m("fieldset",m("legend","allowed data sources"),m("label",m("span","user: "),m(SelectInput,{name:"username",required:1,options:toSelectOptions(this.users,false,"name","name"),value:this.usernameInput,onchange:(e)=>{this.usernameInput=e.target.value;this.getUsersDatasources(this.usernameInput);this.getUsersAvailableDatasources(this.usernameInput);}})),m("table.mt-10",{style:"min-width: 500px"},m("thead",m("tr",[m("th","vendor"),m("th","name"),m("th","location"),m("th","action"),])),m("tbody",this.registeredDSs.length===0?m("tr",m("td[colspan=4]","No data sources found.")):this.registeredDSs.map(row=>m("tr",[m(Cell,{val:row.vendor,type:"string"}),m(Cell,{val:row.name,type:"string"}),m(Cell,{val:row.location,type:"string"}),m("td.tar",m("button[type=button]",{title:"remove",onclick:(e)=>{this.deleteUserDatasources(this.usernameInput,row.name);}},m.trust("&#10006;")))])))),m("div.mt-20",m("label",m("span",["allow ",m("b.fake-input",this.usernameInput)," to access: "]),m(SelectInput,{name:"dsname",required:1,options:toSelectOptions(this.notRegisteredDSs,"","name","name","vendor")}),),m("button[type=submit]","submit"),m("div",this.postUserDatasourcesError)),),),App.getIsAdmin()&&m("form.mt-30",{autocomplete:"off",onchange:()=>{this.addDSError="";this.testDataSourceResult="";},onsubmit:(e)=>{e.preventDefault();const name=e.target.elements["name"].value;const vendor=e.target.elements["vendor"].value;const location=e.target.elements["location"].value;this.postDatasources(name,vendor,location).then(()=>{e.target.reset();})}},m("fieldset",m("legend","add a new data source"),m("table",{style:"min-width: 500px"},m("tr",m("td",{title:"the label of the data source",},"name:"),m("td",m("input",{name:"name",required:1,pattern:"^[a-zA-Z0-9_\\-]{1,30}$",}))),m("tr",m("td","DB vendor:"),m("td",m(SelectInput,{name:"vendor",required:1,options:toSelectOptions(this.vendors,"","name","name"),value:this.vendorInput,onchange:(e)=>{this.vendorInput=e.target.value;}}))),m("tr",m("td",{title:"the driver-specific data source name, usually consisting of at least a database name and connection information",},"location:"),m("td",m("input",{name:"location",required:1,value:this.locationInput,oninput:(e)=>{this.locationInput=e.target.value;}}))),m("tr",m("td"),m("td",m("button[type=submit].mr-20","add"),m("button[type=button].mr-10",{disabled:!this.vendorInput||!this.locationInput,onclick:()=>{this.testDataSource(this.vendorInput,this.locationInput)}},"test"),))),m("pre",this.testDataSourceResult),m("span.error",this.addDSError))),App.getIsAdmin()&&m("form.mt-30",{autocomplete:"off",onchange:()=>{this.postUsersError="";},onsubmit:(e)=>{e.preventDefault();const username=e.target.elements["name"].value;const isadmin=e.target.elements["isadmin"].value;const password=e.target.elements["password"].value;this.postUsers(username,isadmin,password).then(()=>{e.target.reset();});}},m("fieldset",m("legend","add a new user"),m("table",m("tr",m("td","name:"),m("td",m("input",{name:"name",required:1,pattern:"^[a-zA-Z0-9_\\-]{1,20}$",}))),m("tr",m("td","admin:"),m("td",m(SelectInput,{name:"isadmin",required:1,options:[{label:"",value:""},{label:"no",value:"0"},{label:"yes",value:"1"}]}))),m("tr",m("td","password:"),m("td",m("input[type=password]",{name:"password",autocomplete:"off",required:1,}))),m("tr",m("td"),m("td",m("button[type=submit]","add")))),m("span.error",this.postUsersError),)),]}}}
const JWT_KEY="jwt";const App={theme:"",dataTransferAction:false,claims:{},isLogged:()=>{const jwt=localStorage.getItem(JWT_KEY);if(jwt===null)
return false
App.claims=parseJwt(jwt);if(App.claims.exp&&Date.now()/1000>App.claims.exp){localStorage.removeItem(JWT_KEY);return false}
return true;},logout:()=>{localStorage.removeItem(JWT_KEY)},login:(token)=>{localStorage.setItem(JWT_KEY,token)},getAuthHeaders:()=>{return{"Authorization":"Bearer "+localStorage.getItem(JWT_KEY)}},getUsername:()=>{return App.claims.name},getIsAdmin:()=>{return App.claims.isadmin===1||App.claims.isadmin==="1";},oninit:()=>{var theme=localStorage.getItem("theme");App.theme=theme?theme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark-mode":"light-mode";App.pageState=new UIState({def:window.location.hash.substring(1)||localStorage.getItem("pageState")||"datasources",onSet:(tab)=>{localStorage.setItem("pageState",tab)}});},view:()=>{return[m("div.grid-main",{class:App.theme},m("header.area-main-header.sticky",m("div.grid",{style:"grid-template-columns: auto 1fr auto;"},m("div.grid-col.text-smaller",m("a.no-underline",{href:"/",title:"refresh page"},versionInfo.AppName),m("span.ml-10","v",versionInfo.AppVersion),),m("div.grid-col.ml-auto.mr-auto",App.getIsAdmin()&&[m("a.tab.tab-b.mr-30.no-underline",{href:"#datasources",class:App.pageState.selectedClass("datasources"),onclick:()=>{App.pageState.set("datasources");}},m.trust("&#128279;data sources"))],m("a.tab.tab-b.mr-30.no-underline",{href:"#query",class:App.pageState.selectedClass("query"),onclick:()=>{App.pageState.set("query");}},m.trust("&#128462;&ThinSpace;SQL editor")),m("a.tab.tab-b.no-underline",{href:"#copy",class:App.pageState.selectedClass("copy"),onclick:()=>{App.pageState.set("copy");}},m.trust("&#8644;&ThinSpace;copy data")),),m("div.grid-col.ml-auto.mr-0",m("div.ml-10",m(ThemeSwitch)),m("div.ml-10",m(LogoutInput))),),),App.isLogged()?[m("div",{class:App.pageState.displayClass("datasources")},m(DatasourcesPage)),m("div",{class:App.pageState.displayClass("query")},m(QueryPage)),m("div",{class:App.pageState.displayClass("copy")},m(CopyDataPage)),]:m("div",m(LoginForm)),m("footer.area-footer-content.ml-auto.mr-0.text-x-small",m("div",m("a",{href:"https://github.com/a-le/"+versionInfo.AppName,target:"_blank",title:"View github project page"},versionInfo.AppName),m("span",m.trust(" &copy; 2025. Licensed under "),m("a",{href:"https://www.gnu.org/licenses/agpl-3.0.html",title:"View License",target:"_blank"},"AGPL"),),)))];}};